name: Weekly Codebase Scan

on:
  schedule:
    # Run every Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Analyze only, do not create PR'
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

# Only one scan at a time
concurrency:
  group: weekly-codebase-scan
  cancel-in-progress: false

jobs:
  scan-and-fix:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Run codebase scan
        id: scan
        uses: docker/cagent-action@latest
        with:
          agent: ${{ github.workspace }}/.github/agents/codebase-scanner.yaml
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          yolo: 'true'
          timeout: 600  # 10 minutes - based on typical scan time of 5-7min + buffer

      - name: Validate changes (anti-hallucination check)
        id: validate
        run: |
          OUTPUT_FILE="${{ steps.scan.outputs.output-file }}"

          # Check if any files were modified
          CHANGED_FILES=$(git diff --name-only)
          if [ -z "$CHANGED_FILES" ]; then
            echo "‚úÖ No changes made"
            echo "has_valid_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "üìù Files modified by agent:"
          echo "$CHANGED_FILES"

          # Check for unexpected new files (potential hallucination)
          NEW_FILES=$(git diff --diff-filter=A --name-only)
          if [ -n "$NEW_FILES" ]; then
            echo "::warning::Agent created new files (unexpected for a scan):"
            echo "$NEW_FILES"
            echo "Reverting new files..."
            echo "$NEW_FILES" | xargs -I {} git checkout HEAD -- "{}" 2>/dev/null || true
          fi

          # Check for deleted files (potential hallucination)
          DELETED_FILES=$(git diff --diff-filter=D --name-only)
          if [ -n "$DELETED_FILES" ]; then
            echo "::warning::Agent deleted files:"
            echo "$DELETED_FILES"
            # Only allow deletion of test files
            for f in $DELETED_FILES; do
              if [[ ! "$f" =~ _test\.go$ ]]; then
                echo "::error::Agent deleted non-test file: $f - reverting"
                git checkout -- "$f"
              fi
            done
          fi

          # Validate each changed file exists and has valid changes
          INVALID_COUNT=0
          VALID_COUNT=0

          # Re-fetch changed files after reverting hallucinated ones
          CHANGED_FILES=$(git diff --name-only)

          while IFS= read -r filepath; do
            [ -z "$filepath" ] && continue

            if [ -f "$filepath" ]; then
              # For Go files, do basic syntax check
              if [[ "$filepath" =~ \.go$ ]]; then
                if ! gofmt -e "$filepath" >/dev/null 2>&1; then
                  echo "  ‚úó INVALID (syntax error): $filepath"
                  git checkout -- "$filepath"
                  INVALID_COUNT=$((INVALID_COUNT + 1))
                  continue
                fi
              fi

              echo "  ‚úì Valid: $filepath"
              VALID_COUNT=$((VALID_COUNT + 1))
            else
              echo "  ‚úó INVALID (file doesn't exist): $filepath"
              INVALID_COUNT=$((INVALID_COUNT + 1))
              # Revert changes to non-existent files
              git checkout -- "$filepath" 2>/dev/null || true
            fi
          done <<< "$CHANGED_FILES"

          echo ""
          echo "Validation results:"
          echo "  - Valid changes: $VALID_COUNT"
          echo "  - Invalid changes (reverted): $INVALID_COUNT"

          if [ "$VALID_COUNT" -gt 0 ]; then
            echo "has_valid_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_valid_changes=false" >> $GITHUB_OUTPUT
          fi

          if [ "$INVALID_COUNT" -gt 0 ]; then
            echo "::warning::Agent made changes to $INVALID_COUNT invalid files (hallucination). These have been reverted."
          fi

      - name: Verify build
        if: steps.validate.outputs.has_valid_changes == 'true'
        run: |
          echo "üî® Verifying changes compile..."
          # 5 minute timeout to prevent hangs from infinite loops
          if ! timeout 300 go build ./...; then
            if [ $? -eq 124 ]; then
              echo "::error::Build timed out after 5 minutes. Reverting all changes."
            else
              echo "::error::Changes do not compile. Reverting all changes."
            fi
            git checkout -- .
            echo "build_failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "‚úÖ Build successful"

      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "üìù Final changes to commit:"
            git status --porcelain
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No valid changes to commit"
          fi

      - name: Gather change details
        if: steps.changes.outputs.has_changes == 'true' && inputs.dry-run != true
        id: gather
        run: |
          # Get list of changed files with stats
          echo "üìã Gathering change details..."

          # Changed files list
          git diff --stat > files_stat.txt

          # Full diff for analysis
          git diff > changes.diff

          # Count stats
          FILES_CHANGED=$(git diff --name-only | wc -l | tr -d ' ')
          ADDITIONS=$(git diff --numstat | awk '{sum += $1} END {print sum+0}')
          DELETIONS=$(git diff --numstat | awk '{sum += $2} END {print sum+0}')

          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "additions=$ADDITIONS" >> $GITHUB_OUTPUT
          echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT

          echo "üìä Stats: $FILES_CHANGED files, +$ADDITIONS/-$DELETIONS lines"

      - name: Generate PR description
        if: steps.changes.outputs.has_changes == 'true' && inputs.dry-run != true
        id: describe
        uses: docker/cagent-action@latest
        with:
          agent: agentcatalog/github-action-pr-description-generator
          prompt: |
            Generate a PR description for automated codebase scan fixes.

            **Context:**
            This PR was automatically generated by a weekly codebase scan that looks for:
            - Security vulnerabilities (injection, auth bypass, secrets)
            - Logic errors (nil deref, ignored errors)
            - Resource leaks (unclosed files, connections)
            - Concurrency bugs (races, deadlocks)

            **Stats:** ${{ steps.gather.outputs.files_changed }} files changed, +${{ steps.gather.outputs.additions }}/-${{ steps.gather.outputs.deletions }} lines

            **Changed Files:**
            $(cat files_stat.txt)

            **Diff:**
            $(cat changes.diff)

            **Instructions:**
            1. Summarize what issues were found and fixed
            2. Group related changes together
            3. Explain WHY each change was made (the bug it fixes)
            4. Be concise but informative
            5. End with the standard footer (validation performed, review checklist)

            Format the description in GitHub Markdown.
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          timeout: 180

      - name: Read generated description
        if: steps.changes.outputs.has_changes == 'true' && inputs.dry-run != true
        id: read-description
        run: |
          OUTPUT_FILE="${{ steps.describe.outputs.output-file }}"
          if [ -f "$OUTPUT_FILE" ]; then
            # Read the description, escaping for GitHub Actions
            {
              echo "body<<DESCRIPTION_EOF"
              cat "$OUTPUT_FILE"
              echo ""
              echo "---"
              echo "*Generated by [cagent-action](https://github.com/docker/cagent-action) ‚Ä¢ [Workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*"
              echo "DESCRIPTION_EOF"
            } >> $GITHUB_OUTPUT
          else
            # Fallback description if generation failed
            {
              echo "body<<DESCRIPTION_EOF"
              echo "## Automated Codebase Scan"
              echo ""
              echo "This PR was automatically generated by the weekly codebase scan workflow."
              echo ""
              echo "### Stats"
              echo "- **Files changed:** ${{ steps.gather.outputs.files_changed }}"
              echo "- **Lines:** +${{ steps.gather.outputs.additions }}/-${{ steps.gather.outputs.deletions }}"
              echo ""
              echo "### Validation performed"
              echo "- ‚úÖ All modified files verified to exist"
              echo "- ‚úÖ Build verification passed (\`go build ./...\`)"
              echo ""
              echo "### Review checklist"
              echo "- [ ] Fixes are correct and don't introduce new issues"
              echo "- [ ] Tests pass"
              echo ""
              echo "---"
              echo "*Generated by [cagent-action](https://github.com/docker/cagent-action) ‚Ä¢ [Workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*"
              echo "DESCRIPTION_EOF"
            } >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true' && inputs.dry-run != true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use date-based branch to avoid conflicts with existing PRs
          BRANCH="automated/weekly-codebase-scan-$(date +%Y%m%d)"

          # Check if branch already exists and append run ID if needed
          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "::warning::Branch $BRANCH already exists. Appending run ID."
            BRANCH="${BRANCH}-${{ github.run_id }}"
          fi

          # Create branch and commit
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "fix: automated codebase scan fixes"
          git push -u origin "$BRANCH"

          # Create PR
          PR_URL=$(gh pr create \
            --title "üîç Weekly Codebase Scan - Automated Fixes" \
            --body "${{ steps.read-description.outputs.body }}" \
            --label "automated" \
            --label "automated-scan")

          echo "‚úÖ Pull Request: $PR_URL"

      - name: Cleanup temporary files
        if: always()
        run: |
          rm -f files_stat.txt changes.diff || true
